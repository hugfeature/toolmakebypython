import json
import constans
import common_model

# 漏洞路径
vul_url = '/asset-svc/infoRisk/list'
url = constans.PROD_URL + vul_url
data = {
  "current": 1,
  "size": 200,
  "searchType": 2,
  "tentantIds": "1376910930495549442,1376911239573811202,1376911512404897794,1376911830253449217,1376912476457283586,1376912692174532610,1376913856316190722,1384324273049800705,1386862016857911297,1386864448069447681,1386865324729315329,1386866133280571393,1386866421135654914,1386866822635405313,1386867812505235457,1386868115845689345,1386868441821298690,1386868894547587074,1386869257936388097,1386869722784215042,1386870390515908610,1386872738396516353,1386873054532288513,1386873492461072385,1386875633320411138,1386876751068872706,1386877155560665090,1386877677592129537,1386877920903704577,1386878597850284033,1386879886529216514,1386880575545815042,1386881324902858754,1386881564290068481,1386882813876584450,1386883104165867522,1386883487188205570,1386883772161802241,1386884171310051329,1386884514704605185,1386885027090673665,1387249151116472322,1387250219078545409,1387250739063189505,1387251581159813121,1387252207679778818,1387252506161213441,1387305210503835649,1387306595783962625,1387306866511523841,1387307141301350401,1387307546192277505,1387307839927775233,1387308347530833922,1387308972352106497,1387309289722507265,1387309934116417537,1387313186075734018,1387313419182567425,1387313667982307329,1387314465415966722,1387315277162770433,1387316201511874562,1387316766304268290,1387317211588358145,1387317487749722114,1387317700444893186,1387318028280082434,1387318250521653250,1387318478664445954,1387318729171431425,1387318949500235777,1387319451493494786,1388500795117531138,1388501206227427329,1388501551422840834,1388520521739739138,1399258836491243521,1399920719037419521,1399920958173220866,1413148966571040769,1415189011284168705,1425029965694038018,1425707662787145730,1432975326994726914,1433341489683595266,1436248946592411650,1443411507318702082,1446751404741967874,1446776799751127041,1453656592021417986,1458342006079041537,1468422843798859777,1475762129550176257,1476455114367524865,1513408832989192193,1524635997076606978,1535171708544065538,1539899991319879682,1544191592059211778,1564131502198247426,1590935780249378818,1592690185862737922,1592769457042321410,1610534309073199106,1659402200422383617,1671443835517038594,1673963354231218178,1681102166245715969,1752994841723428865,1773225670053957634",
  "loophloleLevels": "5, 4, 3",  # 漏洞等级：严重、高危、中危
  "loopholeStatus": "2",  # 漏洞状态：已修复
  'sourceVO': 300, # 漏洞来源：自动监测
  "startTime": constans.START_TIME,
  "endTime": constans.END_TIME,
  "intraExtraNet": 2
}
# 获取已修复漏洞
vul_list = common_model.send_post_request(url, data,constans.PROD_TOKEN)
data_list = json.loads(vul_list) # type: ignore
# print(data_list)
# 获取工单编号
orders = common_model.find_all_keys(data_list,'orderId')
# print(orders)
# print(len(orders))
params = {  
    'userId': '1643918235382349826' 
} 
num_people = 0
num_error = 0
for order in orders:
    # 获取工作流ID
    order_url = f'{constans.PROD_URL}/src-order-svc/orderRecord/{order}'
    order_detail = common_model.send_get_request_with_author_and_params(order_url,constans.PROD_TOKEN,params)
    instance_id = common_model.get_instanceid(order_detail)
    # 获取任务ID
    task_url = f'{constans.PROD_URL}/workflow-svc/task/findaskByInstanceId'
    params_task = {
        'InstanceId': instance_id
    }
    task_detail = common_model.send_get_request_with_author_and_params(task_url,constans.PROD_TOKEN,params_task)
    task_messg = json.loads(task_detail) # type: ignore
    # 获取复测人名字
    retest_people = common_model.get_retest(task_messg,'assignee')
    # 获取复测任务ID
    retest_task_id = common_model.get_retest(task_messg,'taskId')
    # print(f'工单ID{order}复测人{retest_people}，任务ID{retest_task_id}')
    reset_url = f'{constans.PROD_URL}/workflow-svc/task/findTaskFormById'
    params_retest = {
        'taskId': retest_task_id
    } 
    retest_detail = common_model.send_get_request_with_author_and_params(reset_url,constans.PROD_TOKEN,params_retest)
    retest_messg = json.loads(retest_detail) # type: ignore
    # 获取复测任务理由
    retest_reason = common_model.get_reson(retest_messg)
    print(f'工单ID：{order}复测人：{retest_people}，任务ID：{retest_task_id},通过理由：{retest_reason}')

